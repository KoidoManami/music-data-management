# 楽曲データ管理システム（チェックボックス形式）

Gmail で受信した未処理楽曲データを自動的に GitHub の既存Issue（#5649）にチェックボックス形式で追記するシステムです。

## 🎯 目的

- Gmail で個別に送られてくる未処理楽曲データの通知を一元管理
- **ptna-office/tasks の Issue #5649** にチェックボックス形式で自動追記
- 処理完了時にチェックマークを付けることで進捗管理を実現

## 📋 出力フォーマット

### ✅ チェックボックス形式
システムが生成する形式：
```markdown
- [ ] 798738　ギロック／インディアンの雨乞いダンスはじめてのギロック／全音楽譜出版社
```

### 📊 データ構成
- **チェックボックス**: `- [ ]` (処理完了時に `- [x]` に変更可能)
- **申込番号**: `798738`
- **楽曲情報**: `ギロック／インディアンの雨乞いダンス`
- **詳細情報**: `はじめてのギロック` (メール本文から自動抽出)
- **出版社**: `／全音楽譜出版社`

## 🚀 セットアップ

### 1. リポジトリのクローン
```bash
git clone https://github.com/KoidoManami/music-data-management.git
cd music-data-management
npm install
```

### 2. 環境変数の設定
`.env.example` を `.env` にコピーして設定：

```env
# GitHub設定（ptna-office/tasks へのアクセス権限が必要）
GITHUB_TOKEN=your_github_personal_access_token_here

# Gmail API設定
GMAIL_CLIENT_ID=your_gmail_client_id_here
GMAIL_CLIENT_SECRET=your_gmail_client_secret_here
GMAIL_REFRESH_TOKEN=your_gmail_refresh_token_here

# システム設定
CRON_SCHEDULE=0 * * * *  # 毎時間実行
```

### 3. 実行とテスト

```bash
# フォーマットテスト（安全）
npm run test:issue

# 実際のIssue更新テスト
npm run test:issue:update

# 本番実行（一回のみ）
npm start -- --once

# 定期実行（毎時間）
npm start
```

## 💻 システムの動作

### メール処理フロー
1. **Gmail監視** → `ptna.sato.miyuki@gmail.com` からのメール
2. **データ抽出** → 申込番号、楽曲情報、詳細情報、出版社
3. **重複チェック** → Issue #5649 内で申込番号をチェック
4. **フォーマット生成** → チェックボックス形式でエントリ作成
5. **Issue更新** → 新しい行として追加

### 詳細情報の抽出
メール本文から以下のパターンで詳細情報を抽出：
```
♪登録曲目

曲目1：ギロック／インディアンの雨乞いダンス
はじめてのギロック／全音楽譜出版社
```
↓
```
- [ ] 798738　ギロック／インディアンの雨乗いダンスはじめてのギロック／全音楽譜出版社
```

## 📝 使用例

### 入力（Gmail）
```
申込番号：798738
step_entry番号：681229

♪登録曲目

曲目1：ギロック／インディアンの雨乞いダンス
はじめてのギロック／全音楽譜出版社
```

### 出力（GitHub Issue #5649）
```markdown
- [ ] 798738　ギロック／インディアンの雨乞いダンスはじめてのギロック／全音楽譜出版社
```

### 処理完了時
手動でチェックマークを付けることで進捗管理：
```markdown
- [x] 798738　ギロック／インディアンの雨乞いダンスはじめてのギロック／全音楽譜出版社
```

## 🔧 カスタマイズ

### 対象Issue番号の変更
`src/gmail-github-integration.js` の `targetIssueNumber` を変更：
```javascript
const targetIssueNumber = 5649; // 変更したいIssue番号
```

### フォーマットの調整
`generateMusicDataEntry()` メソッドでレイアウトを調整：
```javascript
generateMusicDataEntry(musicData, emailData) {
  let entry = '- [ ] '; // チェックボックス
  // ... 楽曲情報の処理
  return entry;
}
```

### メール検索条件の変更
```javascript
q: 'from:ptna.sato.miyuki@gmail.com subject:"AI曲目絞り込み検索不備" OR subject:"曲目メンテ"'
```

## 📊 テスト機能

### テストコマンド
```bash
# フォーマット確認（安全）
npm run test:issue

# 実際のIssue更新
npm run test:issue:update
```

### テスト出力例
```
=== チェックボックス形式 Issue更新テスト開始 ===
チェックボックス形式のデータエントリ生成中...
生成されたエントリ:
- [ ] 798738　ギロック／インディアンの雨乞いダンスはじめてのギロック／全音楽譜出版社

期待する形式:
- [ ] 798738　ギロック／インディアンの雨乞いダンスはじめてのギロック／全音楽譜出版社

重複チェック中...
重複チェック結果: 重複なし
```

## ⚙️ 運用フロー

1. **Gmail受信** → 佐藤さんからの未処理楽曲データメール受信
2. **自動処理** → システムが新しいメールを検出・解析
3. **Issue追記** → チェックボックス形式で Issue #5649 に追加
4. **進捗管理** → 処理完了時に手動でチェックマークを付ける
5. **一覧表示** → Issue #5649 で全体の進捗状況を確認

## ⚠️ 注意事項

1. **リポジトリアクセス権限**
   - `ptna-office/tasks` リポジトリへの書き込み権限が必要
   - Personal Access Token は適切に管理してください

2. **API レート制限**
   - GitHub API: 5000リクエスト/時間
   - Gmail API: 1億クォータユニット/日

3. **重複処理**
   - 申込番号ベースで重複チェックを実施
   - 既に処理済みのデータは自動的にスキップ

## 🎯 進捗管理の活用

### チェックボックスの使い方
- `- [ ]` : 未処理
- `- [x]` : 処理完了

### 一覧での確認
Issue #5649 では、全体の進捗状況を一目で確認可能：
```markdown
- [x] 798695　荒井由実 「魔女の宅急便」より　ルージュの伝言／スタジオジブリ作品集／ドレミ楽譜出版社
- [ ] 798738　ギロック／インディアンの雨乞いダンスはじめてのギロック／全音楽譜出版社
- [ ] 798701　イワノビッチ（橋本晃一編曲）／ドナウ河のさざなみ／ドレミ楽譜出版社
```

## 🤝 コントリビューション

プルリクエストやIssueは歓迎します。大きな変更を行う前に、まずIssueで議論していただけると助かります。

## 📄 ライセンス

MIT License - 詳細は [LICENSE](LICENSE) ファイルを参照してください。